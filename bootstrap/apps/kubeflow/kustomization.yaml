apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Central configuration - UPDATE THESE VALUES INSTEAD OF EACH FILE
namespace: argocd

# Configuration values
configMapGenerator:
- name: repo-config
  literals:
  - REPO_URL=https://github.com/minhhcuongg-theonefour/k8s-inspect.git
  - TARGET_REVISION=feat/refactor-synchronize-script
  options:
    disableNameSuffixHash: true

resources:
# Wave 0: Foundation
- common-services.yaml

# Wave 1: Core (will be added when created)
# - profiles.yaml
# - admission-webhook.yaml

# Wave 2: ML Platform
- kubeflow-pipelines.yaml
- katib.yaml
- jupyter.yaml

# Wave 3: Serving & Training
- kserve.yaml
- trainer.yaml

# Wave 4: Web Apps
- web-apps.yaml
# - pvcviewer-controller.yaml

# Wave 5: Additional
- spark.yaml
- model-registry.yaml
# - user-namespace.yaml

# Replace hardcoded values with centralized configuration
replacements:
# Replace repoURL in Applications with single source
- source:
    kind: ConfigMap
    name: repo-config
    fieldPath: data.REPO_URL
  targets:
  - select:
      kind: Application
    fieldPaths:
    - spec.source.repoURL
    options:
      create: true

# Replace targetRevision in Applications with single source
- source:
    kind: ConfigMap
    name: repo-config
    fieldPath: data.TARGET_REVISION
  targets:
  - select:
      kind: Application
    fieldPaths:
    - spec.source.targetRevision
    options:
      create: true

# Replace repoURL in Applications with multiple sources (jupyter, web-apps)
- source:
    kind: ConfigMap
    name: repo-config
    fieldPath: data.REPO_URL
  targets:
  - select:
      kind: Application
      name: kubeflow-jupyter
    fieldPaths:
    - spec.sources.0.repoURL
    - spec.sources.1.repoURL
  - select:
      kind: Application
      name: kubeflow-web-apps
    fieldPaths:
    - spec.sources.0.repoURL
    - spec.sources.1.repoURL
    - spec.sources.2.repoURL
    - spec.sources.3.repoURL

# Replace targetRevision in Applications with multiple sources
- source:
    kind: ConfigMap
    name: repo-config
    fieldPath: data.TARGET_REVISION
  targets:
  - select:
      kind: Application
      name: kubeflow-jupyter
    fieldPaths:
    - spec.sources.0.targetRevision
    - spec.sources.1.targetRevision
  - select:
      kind: Application
      name: kubeflow-web-apps
    fieldPaths:
    - spec.sources.0.targetRevision
    - spec.sources.1.targetRevision
    - spec.sources.2.targetRevision
    - spec.sources.3.targetRevision

